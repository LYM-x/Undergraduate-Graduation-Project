{% extends 'view/base.html' %}
{% block headadd %}
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-language/v1.0.0/mapbox-gl-language.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet' />

    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
{% endblock headadd %}
{% block content %}
    <style>
        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 0;
            left: 0;
            padding: 10px;
        }

        .map-overlay2 {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 200px;
            left: 0;
            padding: 10px;
        }

        .map-overlay2 .map-overlay-inner {
            background-color: #fff;
            box-shadow:0 1px 2px rgba(0, 0, 0, 0.10);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay3 {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 200px;
            top: 300px;
            left: 0;
            padding: 10px;
        }

        .map-overlay3 .map-overlay-inner3 {
            background-color: #fff;
            box-shadow:0 1px 2px rgba(0, 0, 0, 0.10);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }


        .map-overlay .map-overlay-inner {
            background-color: #fff;
            box-shadow:0 1px 2px rgba(0, 0, 0, 0.10);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay-inner fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }
        .map-overlay-inner3 fieldset {
            border: none;
            padding: 0;
            margin: 0 0 10px;
        }

        .map-overlay-inner3 fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner fieldset:last-child {
            margin: 0;
        }

        .map-overlay-inner select {
            width: 100%;
        }
        .map-overlay-inner3 select {
            width: 100%;
        }

        .map-overlay-inner label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .map-overlay-inner3 label {
            display: block;
            font-weight: bold;
            margin: 0 0 5px;
        }

        .map-overlay-inner button {
            display: inline-block;
            width: 36px;
            height: 20px;
            border: none;
            cursor: pointer;
        }

        .map-overlay-inner3 button {
            display: inline-block;
            width: 81%;
            height: 20px;
            border: none;
            cursor: pointer;
            font-size:10px;
            border-width: 1px;
        }

        .map-overlay-inner3 button:focus {
            outline: none;
        }

        .map-overlay-inner3 button:hover {
            box-shadow:inset 0 0 0 3px rgba(0, 0, 0, 0.10);
        }

        .map-overlay-inner button:focus {
            outline: none;
        }

        .map-overlay-inner button:hover {
            box-shadow:inset 0 0 0 3px rgba(0, 0, 0, 0.10);
        }



        .map-overlay4 {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            position: absolute;
            width: 15%;
            top: 460px;
            left: 0;
            padding: 10px;
        }

        .map-overlay4 .map-overlay-inner {
            background-color: #fff;
            box-shadow:0 1px 2px rgba(0, 0, 0, 0.20);
            border-radius: 3px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .map-overlay4 h2 {
            line-height: 24px;
            display: block;
            margin: 0 0 10px;
        }

        .map-overlay4 .legend .bar {
            height: 10px;
            width: 100%;
            background: linear-gradient(to right, #FCA107, #7F3121);
        }

        .map-overlay4 input {
            background-color: transparent;
            display: inline-block;
            width: 100%;
            position: relative;
            margin: 0;
            cursor: ew-resize;
        }
    </style>


    <div class="tpl-content-wrapper">
        <div id="map" ></div>
        <div id="map_inside">
            <div class='map-overlay top'>
                <div class='map-overlay-inner'>
                    <fieldset>
                        <label>Select layer</label>
                        <select id='layer' name='layer'>
                            <option value='water'>Water</option>
                            <option value='building'>Buildings</option>
                        </select>
                    </fieldset>
                    <fieldset>
                        <label>Choose a color</label>
                        <div id='swatches'></div>
                    </fieldset>
                </div>
            </div>
            <div class="map-overlay2 top">
                <div class='map-overlay-inner'>
                    <fieldset>
                        <label>Select map</label>
                        <select id='maps' name='maps'>
                            <option value='Map1'>Map1</option>
                            <option value='Map2'>Map2</option>
                        </select>
                    </fieldset>
                </div>
            </div>

            <div class='map-overlay4 top'>
                <div class='map-overlay-inner'>
                    <h2>预测步数</h2>
                    <label id='step'></label>
                    <input id='slider' type='range' min='0' max='{{ max_pren }}' step='1' value='0' />
                </div>
                {#                <div class='map-overlay-inner'>#}
                {#                    <div id='legend' class='legend'>#}
                {#                        <div class='bar'></div>#}
                {#                        <div>Magnitude (m)</div>#}
                {#                    </div>#}
                {#                </div>#}
            </div>
            {#            <div class="map-overlay3 top">#}
            {#                <div class='map-overlay-inner3'>#}
            {#                    <fieldset>#}
            {#                        <label>Select data</label>#}
            {#                        <select style="width: 100%" multiple data-am-selected="{maxHeight: 170}" id="select_data">#}
            {#                            <optgroup label="Lstm">#}
            {#                                {% for ex in experiments %}#}
            {#                                    {% if ex.ex_class == 'lstm' %}#}
            {#                                        <option value="{{ ex.id }}">{{ ex.model_name }}</option>#}
            {#                                    {% endif %}#}
            {#                                {% endfor %}#}
            {#                            </optgroup>#}
            {#                            <optgroup label="GCN_lstm">#}
            {#                                {% for ex in experiments %}#}
            {#                                    {% if ex.ex_class == 'GCN_lstm' %}#}
            {#                                        <option value="{{ ex.id }}">{{ ex.model_name }}</option>#}
            {#                                    {% endif %}#}
            {#                                {% endfor %}#}
            {#                            </optgroup>#}
            {#                            <optgroup label="Transformer">#}
            {#                                {% for ex in experiments %}#}
            {#                                    {% if ex.ex_class == 'transformer' %}#}
            {#                                        <option value="{{ ex.id }}">{{ ex.model_name }}</option>#}
            {#                                    {% endif %}#}
            {#                                {% endfor %}#}
            {#                            </optgroup>#}
            {#                            <optgroup label="ConvNext_lstm">#}
            {#                                {% for ex in experiments %}#}
            {#                                    {% if ex.ex_class == 'ConvNext_lstm' %}#}
            {#                                        <option value="{{ ex.id }}">{{ ex.model_name }}</option>#}
            {#                                    {% endif %}#}
            {#                                {% endfor %}#}
            {#                            </optgroup>#}
            {#                        </select>#}
            {#                    </fieldset>#}
            {#                </div>#}
            {#            </div>#}
        </div>


        <div style="position:fixed;bottom: 0px;margin-left: 0px;width: 100%;height: 250px;background-color: #ffffff;z-index: 9999;">
            <div class="am-g" style="margin-left: 0px;">
                <div style="background-color: rgba(247,222,234,0.6)">
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;background-color: #f2f6f9;text-align: center">
                        近7小时空气质量情况
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;background-color: #f2f6f9;text-align: center">
                        此时空气质量
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;background-color: #f2f6f9;text-align: center">
                        此时天气
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;background-color: #f2f6f9;text-align: center">
                    </div>
                </div>
                <div class="am-g" style="margin-left: 0px">
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;">
                        <div id="echarts" style="height: 250px;width:100%"></div>
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;">
                        <div id="echarts2" style="height: 250px;width:100%"></div>
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;">
                        <div id="echarts3" style="height: 250px;width:100%"></div>
                    </div>
                    <div class="am-u-sm-3" style="margin-left: 40px;padding-right: 0px;overflow-x: hidden;word-break:break-all;">
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block script_or_other %}
    {% csrf_token %}
    <script type="text/javascript">
        function bind(obj, eventStr, callback) {
            if (obj.addEventListener) {
                //大部分浏览器兼容的方式
                obj.addEventListener(eventStr, callback, false);
            } else {
                /*
                 * this是谁由调用方式决定
                 * callback.call(obj)
                 */
                //IE8及以下
                obj.attachEvent("on" + eventStr, function () {
                    //在匿名函数中调用回调函数
                    callback.call(obj);
                });
            }
        }

        function createSquaredByPoint(properties,offset){
            var smx = properties.smx;
            var smy = properties.smy;
            var offset_int = parseFloat(offset);
            return [[smx,smy],[smx,smy + offset_int],[smx - offset_int,smy + offset_int],[smx - offset_int,smy],[smx,smy]];
        }

        function getGeometry(feature,weight,breadth){
            feature.features.forEach(item => {
                if (item.geometry && item.geometry.coordinates) {
                    item.geometry.coordinates[0] = createSquaredByPoint(item.properties,breadth);
                    item.properties.height = item.properties.height * weight;
                } else {
                    console.log("item.geometry.coordinates 不存在");
                }

            })
        }

        window.onload = function () {
            $('#view_extend_flag').attr('class','active')
            document.documentElement.style.overflow='hidden';

            mapboxgl.accessToken = 'pk.eyJ1IjoibHlteCIsImEiOiJjbDI4Yzl4MnkwODBxM2twZTU2ZzIzbnRuIn0.s_JB6ZjS9lYxdoJXe_-qgw';


            var map = new mapboxgl.Map({
                style: 'mapbox://styles/mapbox/light-v10',
                {#style:mapStyle,#}
                center: [121.497,31.239],
                zoom: 16,
                pitch: 45,
                bearing: -17.6,
                container: 'map',
                boxZoom:true,
                trackResize:true,
            });
            var hoveredStateId =  null;

            function rotateCamera(timestamp) {
                // clamp the rotation between 0 -360 degrees
                // Divide timestamp by 100 to slow rotation to ~10 degrees / sec
                map.rotateTo((timestamp / 150) % 360, {duration: 0});
                // Request the next frame of the animation.
                animation_id = requestAnimationFrame(rotateCamera);
            }








            a =  $.ajax({
                url: "/static/map/js/上海.json",//json文件位置，文件名
                type: "GET",//请求方式为get
                dataType: "json", //返回数据格式为json
                async: false,
                success: function(data) {//请求成功完成后要执行的方法
                    {#console.log(data.features)#}
                    for(i=0;i<data.features.length;i++){
                        data.features[i].id = i+1;
                    }
                    {#console.log(data)#}
                    map.on('load', function() {
// Insert the layer beneath any symbol layer.
                        animation_id = rotateCamera(0);
                        {#console.log('启动地图时：',animation_id)#}
                        {#console.log(animation_id)#}

                        var layers = map.getStyle().layers;

                        var labelLayerId;
                        for (var i = 0; i < layers.length; i++) {
                            if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
                                labelLayerId = layers[i].id;
                                break;
                            }
                        }

                        map.addSource("fillSourceID", {
                            type: "geojson" /* geojson类型资源 */,
                            data: data /* geojson数据 */
                        });



                        map.addLayer({
                            id: "fillID",
                            type: "fill" /* fill类型一般用来表示一个面，一般较大 */,
                            source: "fillSourceID",
                            paint: {
                                "fill-color": '#f08',
                                "fill-opacity": ["case",
                                    ["boolean", ["feature-state", "hover"], false],
                                    1,
                                    0.1
                                ]
                            }
                        }, labelLayerId);

                        map.addLayer({
                            'id': '3d-buildings',
                            'source': 'composite',
                            'source-layer': 'building',
                            'filter': ['==', 'extrude', 'true'],
                            'type': 'fill-extrusion',
                            'minzoom': 15,
                            'paint': {
                                'fill-extrusion-color': '#fd8d3c',
// use an 'interpolate' expression to add a smooth transition effect to the
// buildings as the user zooms in
                                'fill-extrusion-height': [
                                    "interpolate", ["linear"], ["zoom"],
                                    15, 0,
                                    15.05, ["get", "height"]
                                ],
                                'fill-extrusion-base': [
                                    "interpolate", ["linear"], ["zoom"],
                                    15, 0,
                                    15.05, ["get", "min_height"]
                                ],
                                'fill-extrusion-opacity': 1
                            }
                        }, labelLayerId);

                        map.setLayoutProperty('fillID', 'visibility', 'none');


                        var maps = '{{ maps | safe }}';
                        if(maps){
                            var data_select = maps.split(',')
                            console.log('exids=',data_select);
                            var datas = {{ dataset | safe }};
                            var time = {{ xaxis | safe }}
                            var preNs = {{ pren | safe }};
                            var max_pren=0
                            for (var key in preNs){
                                if(preNs[key]>max_pren)
                                    max_pren = preNs[key];
                            }
                            console.log('max_pren',max_pren)
                            $('#slider').attr('max',''+(max_pren-1));

                            var steps=[];
                            for(var i=0;i<max_pren;i++){
                                steps.push('pre'+String(i+1));
                            }

                            function filterBy(step) {
                                var filters = ['==', 'step', step];
                                map.setFilter('entity_layer', filters);
                                // Set the label to the month
                                document.getElementById('step').textContent = steps[step];
                            }

                            var pre_datas=[];
                            var pre_x = []
                            var loc = [
                                [121.398,31.264],
                                [121.488,31.249],
                                [ 121.492	,31.282],
                                [121.446	,31.169],
                                [121.536	,31.305],
                                [120.938,31.093],
                                [ 121.455	,31.235],
                                [119.304	,26.066],
                                [121.638,31.231],
                                [119.304	,26.066],
                            ];
                            for(var j=0;j<data_select.length;j++) {
                                var dataset = datas[data_select[j]];
                                var xaixs = time[data_select[j]]
                                var preN = preNs[data_select[j]]
                                var pre_data = dataset.slice(dataset.length - preN, dataset.length)
                                var pre_xaixs = xaixs.slice(xaixs.length - preN, xaixs.length)

                                {#console.log(pre_data)#}

                                pre_datas.push({
                                    ex_id: data_select[j],
                                    value: pre_data,
                                    lat: loc[j][0],
                                    lnt: loc[j][1]
                                });
                                pre_x.push({
                                    ex_id: data_select[j],
                                    value: pre_xaixs,
                                });
                            }
                            console.log("pre_datas",pre_datas)


                            var geometry={"features":[],"type":"FeatureCollection"}
                            for(var i=0;i<pre_datas.length;i++){
                                for(var j=0;j<max_pren;j++){
                                    if(pre_datas[i].value.length>=j+1){
                                        geometry['features'].push({
                                            "geometry":{
                                                "coordinates":[
                                                    []
                                                ],
                                                "type":"Polygon"
                                            },
                                            "type":"Feature",
                                            "properties":{
                                                "id": i,
                                                "name": "entity"+String(i),
                                                "height": pre_datas[i].value[j],
                                                "smx":pre_datas[i].lat,
                                                "smy":pre_datas[i].lnt,
                                                "step":j
                                            }
                                        })
                                    }
                                }

                            }



                        }
                        else{
                            var geometry = {
                                "features":[
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 1,
                                            "name": "entity1",
                                            "height": 100,
                                            "smx":121.497,
                                            "smy":31.239,
                                            "step":1
                                        }
                                    },
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 2,
                                            "name": "entity2",
                                            "height": 500,
                                            "smx":121.40,
                                            "smy":31.239,
                                            "step":1
                                        }
                                    },
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 3,
                                            "name": "entity3",
                                            "height": 300,
                                            "smx":121.5,
                                            "smy":31.0,
                                            "step":2
                                        }
                                    },
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 4,
                                            "name": "entity4",
                                            "height": 400,
                                            "smx":121.37,
                                            "smy":31.239,
                                            "step":2
                                        }
                                    },
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 5,
                                            "name": "entity5",
                                            "height": 1000,
                                            "smx":121.8,
                                            "smy":31.1,
                                            "step":2
                                        }
                                    },
                                    {
                                        "geometry":{
                                            "coordinates":[
                                                []
                                            ],
                                            "type":"Polygon"
                                        },
                                        "type":"Feature",
                                        "properties":{
                                            "id": 6,
                                            "name": "entity6",
                                            "height": 200,
                                            "smx":121.497,
                                            "smy":31.1,
                                            "step":1
                                        }
                                    }
                                ],
                                "type":"FeatureCollection"
                            };
                        }

                        console.log('geometry',geometry)


                        getGeometry(geometry,2000,0.015);
                        geometry.features.forEach(item => {
                            let he = 0;
                            if (item.properties.height === "" || item.properties.height == 0) {
                                he = 5;   //默认高度
                            }else {
                                he = item.properties.height;
                            }
                            //属性数据
                            item.properties.id = parseInt(item.properties.id);
                            item.properties.height = parseInt(he);
                        });

                        if(map.getSource("states")){
                            map.getSource("states").setData(geometry)
                        }else{
                            map.addSource("states", {
                                "type": "geojson",
                                "data": geometry
                            });
                        }

                        map.addLayer({
                            'id': 'entity_layer',
                            'source': 'states',
                            'type': 'fill-extrusion',
                            'layout': {},
                            'minzoom': 2,       //最小可见级别
                            'maxzoom':12,
                            'paint': {
                                //设置主体默认颜色
                                'fill-extrusion-color': [
                                    "interpolate",
                                    ["exponential",1],
                                    ["get", "height"],
                                    //分类颜色设置（必须按顺序）
                                    500,
                                    '#d6debf',
                                    1000,
                                    '#aecea1',
                                    1500,
                                    '#82bb92',
                                    2500,
                                    '#49838a',
                                    3500,
                                    '#383c65',
                                    5000,
                                    '#2b1e3d'
                                ],
                                'fill-extrusion-height': [
                                    "interpolate", ["linear"], ["zoom"],4, 0,14.05, ["get", "height"]

                                ],
                                'fill-extrusion-base': [
                                    "interpolate", ["linear"], ["zoom"],4, 0,14.05, ["get", "base_height"]
                                ],
                                'fill-extrusion-opacity': .8         //透明度
                            }
                        });

                        filterBy(0);

                        document.getElementById('slider').addEventListener('input', function(e) {
                            var step = parseInt(e.target.value, 10);
                            filterBy(step);
                        });



                    });
                }
            });


// The 'building' layer in the mapbox-streets vector source contains building-height
// data from OpenStreetMap.

            map.addControl(new MapboxLanguage({
                defaultLanguage: 'zh-Hans'}))

            map.on('click', function (e) {
                var features = map.queryRenderedFeatures(e.point);
                {#console.log(JSON.stringify(features, null, 2))#}
                {#document.getElementById('features').innerHTML = JSON.stringify(features, null, 2);#}
            });
            // When the user moves their mouse over the state-fill layer, we'll update the
// feature state for the feature under the mouse.
            map.on("mousemove", "fillID", function(e) {
                if (e.features.length > 0) {
                    if (hoveredStateId) {
                        map.setFeatureState({source: 'fillSourceID', id: hoveredStateId}, { hover: false});
                    }
                    hoveredStateId = e.features[0].id;
                    {#console.log(e.features[0].id)#}
                    map.setFeatureState({source: 'fillSourceID', id: hoveredStateId}, { hover: true});
                }
            });

// When the mouse leaves the state-fill layer, update the feature state of the
// previously hovered feature.
            map.on("mouseleave", "fillID", function() {
                if (hoveredStateId) {
                    map.setFeatureState({source: 'fillSourceID', id: hoveredStateId}, { hover: false});
                }
                hoveredStateId =  null;
            });



            var swatches = document.getElementById('swatches');
            var layer = document.getElementById('layer');
            var colors = [
                '#cad2d3',
                '#aaa',
                '#ffffcc',
                '#a1dab4',
                '#41b6c4',
                '#2c7fb8',
                '#253494',
                '#fed976',
                '#feb24c',
                '#fd8d3c',
                '#f03b20',
                '#bd0026'
            ];

            colors.forEach(function(color) {
                var swatch = document.createElement('button');
                swatch.style.backgroundColor = color;
                swatch.addEventListener('click', function() {
                    if(layer.value==='building') {
                        map.setPaintProperty('3d-buildings', 'fill-extrusion-color', color);
                    }else{
                        map.setPaintProperty(layer.value, 'fill-color', color);
                    }
                });
                swatches.appendChild(swatch);
            });


            $("#maps").change(function (e){
                var map_select = $("#maps").find("option:selected").val();
                if(map_select==='Map1'){
                    map.setLayoutProperty('fillID', 'visibility', 'none');
                    map.setCenter([121.497,31.239]);
                    map.setZoom(16);
                    animation_id = rotateCamera(0);
                }
                else if(map_select==='Map2'){
                    map.setLayoutProperty('fillID', 'visibility', 'visible');
                    map.setCenter([121.418901,30.8]);
                    map.setZoom(9);
                    map.setBearing(0);
                    {#console.log(animation_id);#}
                    cancelAnimationFrame(animation_id);
                }
                {#console.log(map_select);#}
            })


            $("#select_data").change(function (e){
                var data_select = $("#select_data").val();
                {#console.log(data_select);  //['16', '18', '19']#}



                {#console.log('sucecess:',pre_datas);#}

                if(map.getLayer('entity_layer')){
                    map.removeLayer('entity_layer');
                };


            })





            var myChart = echarts.init(document.getElementById('echarts'), 'white', {renderer: 'canvas'});
            myChart.resize();
            var myChart2 = echarts.init(document.getElementById('echarts2'), 'white', {renderer: 'canvas'});
            myChart2.resize();

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": 'http://service.envicloud.cn:8082/v2/cityairlive/BHLTMTY0ODAXNTA5NDG0MG==/101020100',
                "method": "GET",
            }

            $.ajax(settings).done(function (response) {
                {#console.log(response);#}
                var data = [response.CO,response.NO2,response.SO2,response.PM25,response.PM10]
                var name=['CO(mg/m3)','NO2(μg/m3)','SO2(μg/m3)','PM25(μg/m3)','PM10(μg/m3)']
                var lebal = ['name','data']
                var dataset=[name,data]
                const colors = ['#c23531','#2f4554', '#61a0a8', '#d48265', '#91c7ae','#749f83'];

                var seriesm = []
                for(k=1;k<dataset.length;k++){
                    seriesm.push({
                        name: lebal[k],
                        type: 'bar',
                        stack: 'total',
                        label: {
                            show: true
                        },
                        emphasis: {
                            focus: 'series'
                        },
                        data: dataset[k],
                        itemStyle: {
                            normal:{
                                color: function(params){
                                    return colors[params.dataIndex];
                                    // 取每条数据的 index 对应 colors 中的 index 返回这个颜色
                                }
                            }
                        },
                    },)
                }

                var option = {
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            // Use axis to trigger tooltip
                            type: 'shadow' // 'shadow' as default; can also be 'line' or 'shadow'
                        }
                    },
                    grid: {
                        containLabel: true,
                        x: 0,
                        y:20,
                        x2: 0,
                        y2: 30
                    },
                    xAxis: {
                        type: 'value'
                    },
                    yAxis: {
                        type: 'category',
                        data: dataset[0]
                    },
                    series: seriesm
                };
                option && myChart2.setOption(option);

            });

            var settings2 = {
                "async": true,
                "crossDomain": true,
                "url": 'http://service.envicloud.cn:8082/v2/cityairhistory/BHLTMTY0ODAXNTA5NDG0MG==/101020100',
                "method": "GET",
            }

            $.ajax(settings2).done(function (response) {
                {#console.log(response);#}
                var PM25 = []
                var PM10 =[]
                var co=[]
                var so2=[]
                var no2=[]
                var time = []
                for(var i=0;i<response.history.length;i++){
                    PM25.push(response.history[i].PM25)
                    co.push(response.history[i].CO)
                    no2.push(response.history[i].NO2)
                    so2.push(response.history[i].PM10)
                    PM10.push(response.history[i].SO2)
                    time.push(response.history[i].time)
                }
                var dataset = [time,PM25,PM10,no2,so2,co]
                {#console.log(dataset)#}
                var lebal=['Time','PM25(μg/m3)','PM10(μg/m3)','NO2(μg/m3)','SO2(μg/m3)','CO(mg/m3)']
                var seriesm = []
                for(k=1;k<dataset.length;k++){
                    seriesm.push({
                        data: dataset[k],
                        name:lebal[k],
                        type: 'line',
                    },)
                }

                var option = {
                    xAxis: {
                        type: 'category',
                        data: dataset[0],
                        splitLine: {
                            show: true,
                        },
                    },
                    yAxis: {
                        type: 'value',
                        splitLine: {
                            show: true,
                        },
                    },
                    series: seriesm,
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {
                            type: 'shadow'
                        },
                        {#formatter: '{a} <br/>{b} : {c} <br/>'#}
                    },
                    legend: {
                        textStyle: {
                            //图例字体大小
                            fontSize: 10,
                        },
                        //图例大小
                        itemHeight: 10,
                        //图例滚动显示
                        type: 'scroll',
                        //图例纵向显示
                        orient: 'horizontal',//'vertical'
                        //图例位置
                        right: 0,
                        top: 0,
                        bottom: 30,
                    },
                    grid: {
                        x: 50,
                        y:30,
                        x2: 30,
                        y2: 50
                    },
                };
                option && myChart.setOption(option);
            });


            var settings3 = {
                "async": true,
                "crossDomain": true,
                "url": 'http://service.envicloud.cn:8082/v2/weatherlive/BHLTMTY0ODAXNTA5NDG0MG==/101020100',
                "method": "GET",
            }

            $.ajax(settings3).done(function (response) {
                {#console.log(response);#}
                var phenomena = []
                var temperature=[]
                var humidity=[]
                var windpower=[]
                var rain = []

                var weather={
                    '晴':'sunny',
                    '多云':'cloudy',
                    '阴':	'overcast',
                    '阵雨':	'shower',
                    '雷阵雨':	'thundershower',
                    '雷阵雨伴有冰雹':	'thundershower',
                    '雨夹雪':	'sleet',
                    '小雨'	:'lightrain',
                    '中雨'	:'moderaterain',
                    '冻雨'	:'hail',
                    '大雨'	:'heavyrain',
                    '暴雨'	:'storm',
                    '大暴雨'	:'storm',
                    '特大暴雨':	'storm',
                    '阵雪'	:'snowflurry',
                    '小雪'	:'lightsnow',
                    '中雪'	:'moderatesnow',
                    '大雪'	:'heavysnow',
                    '暴雪'	:'blizzard',
                    '雾'	:'foggy',
                    '浮尘'	:'dust',
                    '扬沙'	:'sand',
                    '沙尘暴'	:'duststorm',
                    '强沙尘暴':	'duststorm',
                    '霾'	:'haze'
                }

                phenomena.push(response.phenomena)
                temperature.push(response.temperature)
                windpower.push(response.windpower)
                humidity.push(response.humidity)
                rain.push(response.rain)

                var dataset = [phenomena,temperature,humidity,rain,windpower]
                {#console.log(dataset)#}
                var lebal=['天气','温度(℃)','湿度(%)','降雨量(mm)','风力']
                var divx = document.getElementById('echarts3')
                var txt='<div style="text-align: center;margin-top: 15px">'
                var part1 = '<div id="change_weather"><div><img src="/static/view/img/weather/'+weather[phenomena]+'.png" style="vertical-align:middle;"><span style="font-size: 50px;text-align: center; vertical-align:middle;">'+temperature+'</span>℃</div>'+'<div>'+weather[phenomena]+'&nbsp;&nbsp;&nbsp;&nbsp;'+'<span class="am-icon-tint"></span>'+'&nbsp;'+humidity+'%</div></div>'
                var part1_o = '<div><img src="/static/view/img/weather/'+weather[phenomena]+'.png" style="vertical-align:middle;"><span style="font-size: 50px;text-align: center; vertical-align:middle;">'+temperature+'</span>℃</div>'+'<div>'+weather[phenomena]+'&nbsp;&nbsp;&nbsp;&nbsp;'+'<span class="am-icon-tint"></span>'+'&nbsp;'+humidity+'%</div>'
                var bt = '<div style="margin-top: 10px"><button type="button" id="doc-single-toggle" class="am-btn am-btn-default am-round">查看具体天气信息</button></div>'+'</div>'
                txt = txt+part1+bt
                divx.innerHTML = txt


                var content = ''
                for(var i=0;i<lebal.length;i++){
                    content = content+'<div class="am-g" style="margin-left: 0px;margin-right: 0px">'+lebal[i]+':&nbsp;&nbsp;'+dataset[i]+'</div>'}

                var $toggleButton = $('#doc-single-toggle');
                $toggleButton.on('click', function() {
                    setButtonStatus();
                });

                function setButtonStatus() {
                    var status = $toggleButton.text()
                    {#console.log(status)#}

                    if(status==='查看具体天气信息'){
                        {#console.log('yes')#}
                        $('#doc-single-toggle').text('返回');
                        $('#change_weather').html(content)
                    }else{
                        {#console.log('no')#}
                        $('#doc-single-toggle').text('查看具体天气信息');
                        $('#change_weather').html(part1_o)
                    }
                }


            });

        }
    </script>
{% endblock script_or_other %}




